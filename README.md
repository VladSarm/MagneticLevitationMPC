# MagneticLevitationMPC

This project demonstrates a Model Predictive Control (MPC) implementation for stabilizing a magnetic levitation system (maglev) where a ball is suspended in air using electromagnetic forces. The system is visualized using Pygame with real-time control.

<p align="center">
  <img src="https://github.com/VladSarm/MagneticLevitationMPC/blob/main/movie.gif" alt="full stabilization of maglev" width="400">
</p>
<p align="center">
  <em>Full stabilization of the Magnetic Levitation system using an MPC controller</em>
</p>

## üìã Overview

The system consists of a ball and a coil. The ball is suspended in air using electromagnetic forces. The coil is controlled by a current $u$ which is applied to the coil. The ball is subject to two primary forces:
- Gravity ($F_g = -mg$) pulling it downward
- Electromagnetic force ($F_e$) pushing it upward, generated by a current $u$ through the coil
The net force on the ball is:

$$ F_{net} = F_e - F_g = \frac{ku^2}{(x_1+œµ)^2} - mg $$

where:
- $x_1$: vertical position (height) of the ball [m]

## üöÄ Quick Start

### Prerequisites

If you don't have [uv](https://github.com/astral-sh/uv) (a fast Python package installer and resolver) installed, run:

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### Running the Simulation

To run the standard simulation with full stabilization:

```bash
uv run main.py
```

The plots and animation will be saved to `gfx/MagneticLevitationMPC/`.

To run the simulation with only the backstepping controller (without switching to PD control):

```bash
uv run main.py --backstepping-only
```

This alternative simulation output will be saved to `gfx/MagneticLevitationMPC/`.

## üß† Technical Background



### Physics of the Magnetic Levitation System

The ball is subject to two primary forces:

1. **Gravity** ($F_g = -mg$) pulling it downward
2. **Electromagnetic force** ($F_e$) pushing it upward, generated by a current $u$ through the coil

The net force on the ball is:

$$ F_{net} = F_e - F_g = \frac{ku^2}{(x_1+œµ)^2} - mg $$

where:
- $x_1$: vertical position (height) of the ball [m]
- $u$: control current [A] applied to the electromagnet
- $k$: electromagnetic force constant [N¬∑m¬≤/A¬≤]
- $œµ$: small constant (œµ=0.1) to avoid singularity when $x_1 = 0$
- $m$: mass of the ball [kg] (normalized to 1 in this simulation)
- $g$: gravitational acceleration (9.81 m/s¬≤)

### State-Space Representation

The system dynamics can be represented as:

$$
\begin{align*}
\dot{x}_1 &= x_2 \\
\dot{x}_2 &= -g + \frac{ku^2}{(x_1+œµ)^2}
\end{align*}
$$

where:
- $x_1$: position (height) of the ball
- $x_2$: velocity of the ball

### Discrete-Time Implementation

The continuous-time dynamics are discretized using Euler integration with timestep $Œît = 0.01s$:

$$
\begin{align*}
x_1(t+Œît) &= x_1(t) + Œît \cdot x_2(t) \\
x_2(t+Œît) &= x_2(t) + Œît \cdot \left(-g + \frac{ku(t)^2}{(x_1(t)+œµ)^2}\right)
\end{align*}
$$

### Control Strategy in Detail

The MPC controller is implemented using CasADi. The controller predicts the future trajectory of the ball and adjusts the control input $u$ to minimize the error between the predicted and desired trajectory. For monimization we use the following cost function:

$$
\begin{equation}
J = \sum_{k=0}^{N-1} \underbrace{
    \vphantom{\frac{1}{2}} Q_1 (x_1[k] - r)^2 + 
    Q_2 x_2[k]^2 + 
    R u[k]^2
}_{\text{Stage Cost}}
+ \underbrace{
    Q_1 (x_1[N] - r)^2 + 
    Q_2 x_2[N]^2
}_{\text{Terminal Cost}}
\end{equation}
$$

where:
- $x_1[k]$: position of the ball at time $k$
- $x_2[k]$: velocity of the ball at time $k$
- $u[k]$: control input at time $k$
- $Q_1 = 500$: Penalizes height deviation from target $r$
- $Q_2 = 80$: Penalizes velocity
- $R = 0.1$: Penalizes control effort
- $r = 0.5$: desired position of the ball
- $N = 100$: prediction horizon

The optimization problem is defined as $\min_{\mathbf{u}, \mathbf{x}}  J$ subject to the following constraints:


$$
\begin{align*}
\begin{equation}
\mathbf{x}[0] = \mathbf{x}_{\text{current}} \\
\mathbf{x}[k+1] = f(\mathbf{x}[k], u[k]) \quad \forall k = 0,\dots,N-1 \\
0 \leq u[k] \leq u_{\text{max}}
\end{equation}
\end{align*}
$$




## üìä Results and Discussion

Eventually, the MPC controller was applied to the task of holding a metal ball at a certain height due to the magnetic field generated by the coil. 

<p align="center">
  <img src="https://github.com/VladSarm/MagneticLevitationMPC/blob/main/grafix.jpg" alt="full stabilization of maglev" width="900">
</p>
<p align="center">
  <em>Full stabilization of the Magnetic Levitation system using an MPC controller</em>
</p>

<p align="center">
  <img src="https://github.com/VladSarm/MagneticLevitationMPC/blob/main/movie.gif" alt="full stabilization of maglev" width="400">
</p>
<p align="center">
  <em>Full stabilization of the Magnetic Levitation system using an MPC controller</em>
</p>


## üë®‚Äçüíª Code Structure

The implementation is contained in a single file (`main.py`) with the following key components:

* [**MPCBall Class**](https://github.com/VladSarm/MagneticLevitationMPC/blob/main/main.py#L10): Defines the system dynamics and control methods
* [**Simulation Function**](https://github.com/VladSarm/MagneticLevitationMPC/blob/main/main.py#L141C9-L169C17): Integrates the equations of motion using `solve_ivp` via RK4 scheme
* [**Controller**](https://github.com/VladSarm/MagneticLevitationMPC/blob/main/main.py#L128): Enable PD controller for Acrobot stabilization
* [**Visualization Functions**](https://github.com/VladSarm/MagneticLevitationMPC/blob/main/main.py#L272): Generates plots and animations
* [**Command-Line Interface**](https://github.com/VladSarm/MagneticLevitationMPC/blob/main/main.py#L357): Uses `tyro` for argument parsing



## üôè Authors
* [Egor Miroshnichenko](https://github.com/Chenkomirosh)
* [Anton Bolychev](https://github.com/antonbolychev)
* [Vladislav Sarmatin](https://github.com/VladSarm)
* [Arsenii Shavrin](https://github.com/ArseniiSh)
